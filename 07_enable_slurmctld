#!/usr/bin/env bash
# ------------------------------------------------------------------
# Install /etc/slurm/*.conf and service units, enable slurmctld
# Assumes slurm.conf already prepared/edited by 07_update_slurmconf.
# ------------------------------------------------------------------

set -euo pipefail

# Require root privileges
if [[ $EUID -ne 0 ]]; then
  echo "Error: this script must be run as root (try using sudo)." >&2
  exit 1
fi

# Ensure target directory exists
mkdir -p /etc/slurm

# Copy config files from current working dir -> preserve perms for slurm user group
cp ./slurm.conf /etc/slurm/slurm.conf
chown slurm:slurm /etc/slurm/slurm.conf
chmod 664 /etc/slurm/slurm.conf

# Ensure job_container.conf exists (empty if not present)
touch /etc/slurm/job_container.conf
chown slurm:slurm /etc/slurm/job_container.conf
chmod 664 /etc/slurm/job_container.conf

echo "Installed /etc/slurm/*.conf (owned by slurm:slurm, mode 664)."

# NOTE: SlurmctldHost and AccountingStorageHost are intentionally NOT modified here.
# Those values should be established by 07_update_slurmconf (idempotent, machine-local edits).

# Install systemd unit files
cp ./slurmctld.service /etc/systemd/system/slurmctld.service
cp ./slurmrestd.service /etc/systemd/system/slurmrestd.service

# Reload systemd to pick up new units
systemctl daemon-reload

# Enable and start slurmctld if binary is present
if [ -x /opt/slurm/current/sbin/slurmctld ]; then
    echo "Found /opt/slurm/current/sbin/slurmctld; enabling and starting slurmctld..."
    systemctl enable --now slurmctld
    echo "slurmctld enabled successfully."
else
    cat <<'MSG'
WARNING: /opt/slurm/current/sbin/slurmctld not found.
Create a symlink or install Slurm, for example:
  ln -s /opt/slurm/25.05.3-20251003 /opt/slurm/current
Then rerun: systemctl enable --now slurmctld
MSG
fi
